<div class="container mt-3">
  <!-- Header Section -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center">
        <h3 class="mb-0 fw-bold">{{ 'ORDER_MANAGEMENT.MY_PENDING_ORDERS' | translate }}</h3>
        <div class="d-flex gap-2">
          <button class="btn btn-outline-secondary" (click)="toggleFilterPanel()">
            <i class="bi bi-funnel" [class.bi-funnel-fill]="isFilterExpanded"></i>
            {{ isFilterExpanded ? ('ORDER_MANAGEMENT.HIDE_FILTERS' | translate) : ('ORDER_MANAGEMENT.SHOW_FILTERS' | translate) }}
          </button>
          <button class="btn btn-outline-warning" (click)="clearFilters()">
            <i class="bi bi-arrow-clockwise"></i>
            {{ 'ORDER_MANAGEMENT.CLEAR_FILTERS' | translate }}
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Search and Filter Section -->
  <div class="row mb-4" [formGroup]="filterForm">
    <!-- Search Bar -->
    <div class="col-12 mb-3">
      <div class="input-group">
        <span class="input-group-text">
          <i class="bi bi-search"></i>
        </span>
        <input 
          type="text" 
          class="form-control" 
          formControlName="searchTerm"
          placeholder="{{ 'ORDER_MANAGEMENT.SEARCH_PLACEHOLDER' | translate }}"
          (keyup.enter)="onSearch()"
        />
        <button class="btn btn-primary" type="button" (click)="onSearch()">
          <i class="bi bi-search"></i>
          {{ 'ORDER_MANAGEMENT.SEARCH' | translate }}
        </button>
      </div>
    </div>

    <!-- Advanced Filters -->
    <div class="col-12" *ngIf="isFilterExpanded">
      <div class="card">
        <div class="card-header">
          <h6 class="mb-0">فلاتر متقدمة</h6>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <!-- Date Range -->
            <div class="col-md-3">
              <label class="form-label">من تاريخ</label>
              <input type="date" class="form-control" formControlName="dateFrom" (change)="onFilterChange()" />
            </div>
            <div class="col-md-3">
              <label class="form-label">إلى تاريخ</label>
              <input type="date" class="form-control" formControlName="dateTo" (change)="onFilterChange()" />
            </div>

            <!-- Amount Range -->
            <div class="col-md-3">
              <label class="form-label">الحد الأدنى للمبلغ</label>
              <input type="number" class="form-control" formControlName="minAmount" (change)="onFilterChange()" />
            </div>
            <div class="col-md-3">
              <label class="form-label">الحد الأقصى للمبلغ</label>
              <input type="number" class="form-control" formControlName="maxAmount" (change)="onFilterChange()" />
            </div>

            <!-- Order Type -->
            <div class="col-md-3">
              <label class="form-label">نوع الطلب</label>
              <select class="form-select" formControlName="orderTypeId" (change)="onFilterChange()">
                <option value="">جميع الأنواع</option>
                <option *ngFor="let type of orderTypes" [value]="type.id">
                  {{ type.nameAr }}
                </option>
              </select>
            </div>

            <!-- Status -->
            <div class="col-md-3">
              <label class="form-label">الحالة</label>
              <select class="form-select" formControlName="statusId" (change)="onFilterChange()">
                <option value="">جميع الحالات</option>
                <option *ngFor="let status of statuses" [value]="status.id">
                  {{ status.nameAr }}
                </option>
              </select>
            </div>

            <!-- Customer -->
            <div class="col-md-3">
              <label class="form-label">العميل</label>
              <select class="form-select" formControlName="customerId" (change)="onFilterChange()">
                <option value="">جميع العملاء</option>
                <option *ngFor="let customer of customers" [value]="customer.id">
                  {{ customer.nameAr }}
                </option>
              </select>
            </div>

            <!-- Supplier -->
            <div class="col-md-3">
              <label class="form-label">المورد</label>
              <select class="form-select" formControlName="supplierId" (change)="onFilterChange()">
                <option value="">جميع الموردين</option>
                <option *ngFor="let supplier of suppliers" [value]="supplier.id">
                  {{ supplier.name }}
                </option>
              </select>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading Indicator -->
  <div *ngIf="isLoading" class="text-center py-5">
    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
      <span class="visually-hidden">جاري التحميل...</span>
    </div>
    <p class="mt-3 text-muted">جاري تحميل الطلبات...</p>
  </div>

  <!-- Orders Grid -->
  <div class="row g-3" *ngIf="!isLoading && (orders$ | async) as data">
    <!-- Empty State -->
    <div class="col-12" *ngIf="data.orders.length === 0">
      <div class="text-center py-5">
        <i class="bi bi-inbox fs-1 text-muted mb-3"></i>
        <h5 class="text-muted">لا توجد طلبات</h5>
        <p class="text-muted">لم يتم العثور على أي طلبات تطابق المعايير المحددة</p>
        <button class="btn btn-primary" (click)="clearFilters()">
          <i class="bi bi-arrow-clockwise"></i>
          مسح الفلاتر
        </button>
      </div>
    </div>

    <!-- Order Cards -->
    <div class="col-md-6 col-lg-4" *ngFor="let order of data.orders">
      <div class="card shadow-sm border-0 h-100">
        <!-- Card Header -->
        <div class="card-header d-flex justify-content-between align-items-center" 
             [ngStyle]="{'background-color': getStatusColor(order?.statusId! - 1)}">
          <span class="fw-bold text-white">
            {{ order.orderType?.nameAr }} رقم  – {{ order.id }}  
          </span>
          <i class="bi bi-box-seam text-white fs-5"></i>
        </div>

        <!-- Card Body -->
        <div class="card-body">
          <h6 class="card-title mb-1">
            <i class="bi bi-calendar-date me-1 text-muted ms-2"></i>
            {{ order.orderDate | date: 'yyyy-MM-dd' }}
          </h6>

          <p class="mb-1">
            <i class="bi bi-cash-coin me-1 text-muted ms-2"></i>
            <strong>{{ order.totalAmount | number:'1.2-2' }} د.أ</strong>
          </p>

          <!-- Customer/Supplier Info -->
          <div class="mb-2" *ngIf="order.customer">
            <i class="bi bi-person me-1 text-muted ms-2"></i>
            <small class="text-muted">{{ order.customer.nameAr }}</small>
          </div>
          <div class="mb-2" *ngIf="order.supplier">
            <i class="bi bi-truck me-1 text-muted ms-2"></i>
            <small class="text-muted">{{ order.supplier.name }}</small>
          </div>

          <!-- Items Count -->
          <div *ngIf="order.items?.length! > 0" class="mt-2 d-flex align-items-center">
            <div class="fw-semibold">عدد المواد في الطلب : {{ order.items?.length }}</div>
          </div>

        </div>

        <!-- Card Footer -->
        <div class="card-footer d-flex justify-content-between align-items-center bg-light">
          <span class="badge text-white" 
                [ngStyle]="{'background-color': getStatusColor(order?.statusId! - 1)}">
            {{ order.status?.nameAr }}
          </span>

          <!-- Open in Cart button -->
          <button class="btn btn-sm btn-outline-primary" (click)="openInCart(order)">
            <i class="bi bi-cart-plus"></i> فتح
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Pagination -->
    <nav aria-label="Page navigation" class="mt-4 d-flex justify-content-center">
      <ul class="pagination">
        <li class="page-item" [class.disabled]="+PageIndex.value === 1">
          <button class="page-link btn" (click)="changePage(+PageIndex.value - 1)">«</button>
        </li>

        <!-- First page -->
        <li class="page-item" [class.active]="+PageIndex.value === 1">
          <button class="page-link btn" (click)="changePage(1)">1</button>
        </li>

        <!-- Left Ellipsis -->
        <li class="page-item disabled" *ngIf="+PageIndex.value > 4">
          <span class="page-link">...</span>
        </li>

        <!-- Dynamic middle pages -->
        <li class="page-item" *ngFor="let page of getPageRange()" [class.active]="page === +PageIndex.value">
          <button class="page-link btn" (click)="changePage(page)">{{ page }}</button>
        </li>

        <!-- Right Ellipsis -->
        <li class="page-item disabled" *ngIf="+PageIndex.value < totalPages - 3">
          <span class="page-link">...</span>
        </li>

        <!-- Last page -->
        <li class="page-item" [class.active]="+PageIndex.value === totalPages" *ngIf="totalPages > 1">
          <button class="page-link btn" (click)="changePage(totalPages)">{{ totalPages }}</button>
        </li>

        <li class="page-item" [class.disabled]="+PageIndex.value === totalPages || totalPages === 0">
          <button class="page-link btn" (click)="changePage(+PageIndex.value + 1)">»</button>
        </li>
      </ul>
    </nav>
</div>
