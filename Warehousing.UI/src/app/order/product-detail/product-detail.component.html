<div class="min-h-screen bg-gray-50 py-8" dir="rtl" *ngIf="!isLoading">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <!-- Back Button -->
    <div class="mb-6">
      <button class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-lg text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors" 
              (click)="goBack()">
        <i class="bi bi-arrow-right mr-2"></i>
        {{ 'ORDER.BACK_TO_PRODUCTS' | translate }}
      </button>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8" *ngIf="product">
      <!-- Product Image -->
      <div class="space-y-4">
        <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
          <div class="aspect-square bg-gradient-to-br from-gray-50 to-gray-100 flex items-center justify-center p-8">
            <app-image-uploader [initialImageUrl]="imageUrlService.getImageUrl(product.imagePath, serverUrl)" [readonly]="true">
            </app-image-uploader>
          </div>
        </div>
      </div>

      <!-- Product Details -->
      <div class="space-y-6">
        <div class="bg-white rounded-2xl shadow-lg p-6">
          <!-- Product Name -->
          <h1 class="text-3xl font-bold text-gray-900 mb-4">{{ product.nameAr }}</h1>
          
          <!-- Description -->
          <p class="text-gray-600 text-lg leading-relaxed mb-6">{{ product.description }}</p>

          <!-- Base Price -->
          <div class="bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl p-4 mb-6">
            <div class="flex justify-between items-center">
              <span class="text-lg font-semibold text-gray-700">{{ 'ORDER.BASE_PRICE' | translate }}:</span>
              <span class="text-3xl font-bold text-green-600">{{ product.sellingPrice | currency }}</span>
            </div>
          </div>


          <!-- Enhanced Variant-Store Selection with Direct Cart Management -->
          <div class="mb-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">{{ 'ORDER.SELECT_VARIANT_QUANTITY' | translate }}</h3>
            
            <!-- No variants - show warning for purchases, normal view for sales -->
            <div *ngIf="productVariants.length === 0">
              <!-- For Purchase Orders: Require variants -->
              <div *ngIf="orderTypeId === 1" class="bg-yellow-50 border-2 border-yellow-400 rounded-xl p-6 mb-4">
                <div class="flex items-start">
                  <div class="flex-shrink-0">
                    <i class="bi bi-exclamation-triangle text-yellow-600 text-3xl"></i>
                  </div>
                  <div class="mr-4 flex-1">
                    <h4 class="text-lg font-bold text-yellow-900 mb-2">
                      يرجى إنشاء متغير واحد على الأقل قبل إضافة الكمية
                    </h4>
                    <p class="text-yellow-800 mb-4">
                      لإدارة أفضل للمخزون، يجب إنشاء متغير واحد على الأقل للمنتج قبل إضافة أي كمية. يمكنك إنشاء متغيرات مثل (صغير، متوسط، كبير) أو أي تصنيف آخر مناسب.
                    </p>
                    <button type="button" 
                            class="px-6 py-3 bg-yellow-600 text-white font-semibold rounded-lg hover:bg-yellow-700 transition-colors shadow-md"
                            (click)="goToProductForm()">
                      <i class="bi bi-plus-circle mr-2"></i>
                      إنشاء متغيرات للمنتج
                    </button>
                  </div>
                </div>
              </div>

              <!-- For Sale Orders: Show normal product without variants -->
              <div *ngIf="orderTypeId === 2" class="space-y-4">
                <div *ngFor="let store of allStores" class="bg-gray-50 rounded-xl p-4 border border-gray-200">
                  <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-3">
                    <!-- Store Info -->
                    <div class="flex items-center min-w-0 flex-1">
                      <i class="bi bi-building text-blue-600 mr-3 text-lg flex-shrink-0"></i>
                      <div class="min-w-0">
                        <div class="font-semibold text-gray-900 truncate">{{ store.name }}</div>
                        <div class="text-gray-500 text-sm">{{ store.code }}</div>
                      </div>
                    </div>
                    
                    <!-- Quantity Controls -->
                    <div class="flex flex-col sm:flex-row items-start sm:items-center gap-2 sm:gap-3 w-full sm:w-auto">
                      <span class="text-gray-600 text-sm whitespace-nowrap">{{ 'ORDER.QUANTITY' | translate }}:</span>
                      <div class="flex items-center bg-white rounded-lg border border-gray-300 w-full sm:w-auto min-w-0">
                        <button class="px-2 sm:px-3 py-2 text-red-600 hover:bg-red-50 rounded-r-lg transition-colors flex-shrink-0" 
                                (click)="decreaseQuantity(this.product!.id, store.id)"
                                [disabled]="getCartQuantityForProductStore(this.product!.id, store.id) === 0">
                          <i class="bi bi-dash"></i>
                        </button>
                        
                        <!-- Manual quantity input -->
                        <input type="number" 
                               class="w-full sm:w-16 px-2 py-2 text-center border-0 focus:outline-none focus:ring-0 min-w-0" 
                               [value]="getCartQuantityForProductStore(this.product!.id, store.id)"
                               (change)="setProductQuantity(this.product!.id, store.id, $event)"
                               [max]="getStoreQuantity(store.id)"
                               min="0">
                        
                        <button class="px-2 sm:px-3 py-2 text-green-600 hover:bg-green-50 rounded-l-lg transition-colors flex-shrink-0" 
                                (click)="increaseQuantity(this.product!.id, store.id)"
                                [disabled]="getStoreQuantity(store.id) <= getCartQuantityForProductStore(this.product!.id, store.id)">
                          <i class="bi bi-plus"></i>
                        </button>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Stock Info -->
                  <div class="mt-3 pt-3 border-t border-gray-200">
                    <span class="text-sm text-gray-600">
                      {{ 'ORDER.AVAILABLE_STOCK' | translate }}: <span class="font-semibold text-green-600">{{ getStoreQuantity(store.id) }} {{ product.unit?.nameAr }}</span>
                    </span>
                  </div>
                </div>
              </div>
            </div>

            <!-- With variants - show each variant with stores -->
            <div *ngIf="productVariants.length > 0" class="space-y-6">
              <div *ngFor="let variant of productVariants" class="bg-blue-50 rounded-xl p-4 border border-blue-200">
                <div class="mb-4">
                  <h4 class="text-lg font-semibold text-blue-900 mb-2">
                    <i class="bi bi-tag mr-2"></i>
                    {{ variant.name }}
                    <span *ngIf="variant.priceAdjustment" class="text-green-600 text-sm">
                      (+{{ variant.priceAdjustment | currency }})
                    </span>
                  </h4>
                </div>
                
                <div class="space-y-3">
                  <!-- Show stores for this variant -->
                  <!-- For Purchase Orders: Show all stores (admin chooses where to add) -->
                  <!-- For Sale Orders: Only show stores with stock > 0 (sales person sees what's available) -->
                  <div *ngFor="let store of getStoresForVariant(variant.id!)" class="bg-white rounded-lg p-4 border border-gray-200">
                    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-3">
                      <!-- Store Info -->
                      <div class="flex items-center min-w-0 flex-1">
                        <i class="bi bi-building text-blue-600 mr-3 text-lg flex-shrink-0"></i>
                        <div class="min-w-0">
                          <div class="font-semibold text-gray-900 truncate">{{ store.name }}</div>
                          <div class="text-gray-500 text-sm">{{ store.code }}</div>
                        </div>
                      </div>
                      
                      <!-- Quantity Controls -->
                      <div class="flex flex-col sm:flex-row items-start sm:items-center gap-2 sm:gap-3 w-full sm:w-auto">
                        <span class="text-gray-600 text-sm whitespace-nowrap">{{ 'ORDER.QUANTITY' | translate }}:</span>
                        <div class="flex items-center bg-white rounded-lg border border-gray-300 w-full sm:w-auto min-w-0">
                          <button class="px-2 sm:px-3 py-2 text-red-600 hover:bg-red-50 rounded-r-lg transition-colors flex-shrink-0" 
                                  (click)="decreaseVariantQuantity(variant.id!, store.id)"
                                  [disabled]="getCartQuantityForVariantStore(variant.id!, store.id) === 0">
                            <i class="bi bi-dash"></i>
                          </button>
                          
                          <!-- Manual quantity input -->
                          <input type="number" 
                                 class="w-full sm:w-16 px-2 py-2 text-center border-0 focus:outline-none focus:ring-0 min-w-0" 
                                 [value]="getCartQuantityForVariantStore(variant.id!, store.id)"
                                 (change)="setVariantQuantity(variant.id!, store.id, $event)"
                                 [max]="orderTypeId === 1 ? 999999 : getVariantStockForStore(variant.id!, store.id)"
                                 min="0">
                          
                          <button class="px-2 sm:px-3 py-2 text-green-600 hover:bg-green-50 rounded-l-lg transition-colors flex-shrink-0" 
                                  (click)="increaseVariantQuantity(variant.id!, store.id)"
                                  [disabled]="orderTypeId === 2 && getVariantStockForStore(variant.id!, store.id) <= getCartQuantityForVariantStore(variant.id!, store.id)">
                            <i class="bi bi-plus"></i>
                          </button>
                        </div>
                      </div>
                    </div>
                    
                    <!-- Stock Info -->
                    <div class="mt-3 pt-3 border-t border-gray-200">
                      <span class="text-sm text-gray-600">
                        {{ 'ORDER.AVAILABLE_STOCK' | translate }}: <span class="font-semibold text-green-600">{{ getVariantStockForStore(variant.id!, store.id) }} {{ product.unit?.nameAr }}</span>
                      </span>
                    </div>
                  </div>
                  
                  <!-- Message when no stores available for this variant (only for sale orders) -->
                  <div *ngIf="getStoresForVariant(variant.id!).length === 0 && orderTypeId === 2" 
                       class="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                    <div class="flex items-center">
                      <i class="bi bi-exclamation-triangle text-yellow-600 mr-2"></i>
                      <span class="text-sm text-yellow-800">
                        {{ 'ORDER_MANAGEMENT.NO_VARIANTS_STOCK' | translate }}
                      </span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- No stores available message -->
            <div *ngIf="allStores.length === 0 && orderTypeId === 2" class="bg-yellow-50 border border-yellow-200 rounded-xl p-4">
              <div class="flex items-center">
                <i class="bi bi-exclamation-triangle text-yellow-600 mr-2"></i>
                <span *ngIf="productVariants.length > 0; else noProductStock" class="text-yellow-800">
                  {{ 'ORDER_MANAGEMENT.NO_VARIANTS_STOCK' | translate }}
                </span>
                <ng-template #noProductStock>
                  <span class="text-yellow-800">{{ 'ORDER_MANAGEMENT.NO_PRODUCT_STOCK' | translate }}</span>
                </ng-template>
              </div>
            </div>
          </div>

          <!-- Product Modifiers -->
          <div class="mb-6" *ngFor="let modifier of productModifiers">
            <label class="block text-lg font-semibold text-gray-900 mb-3">
              {{ modifier.modifierName || modifier.modifier?.name }}
              <span *ngIf="modifier.isRequired" class="text-red-500">*</span>
            </label>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
              <div *ngFor="let option of modifier.modifier?.options || []" class="flex items-center">
                <input class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" 
                       type="checkbox" 
                       [id]="'modifier_' + modifier.modifierId + '_' + option.id"
                       [checked]="isModifierOptionSelected(modifier.modifierId, option.id)"
                       (change)="onModifierChange(modifier.modifierId, option.id, ($any($event.target)).checked)">
                <label class="mr-3 text-sm text-gray-700" [for]="'modifier_' + modifier.modifierId + '_' + option.id">
                  {{ option.name }}
                  <span *ngIf="option.priceAdjustment" class="text-green-600 font-semibold">
                    (+{{ option.priceAdjustment | currency }})
                  </span>
                </label>
              </div>
            </div>
          </div>

          <!-- Cart Summary -->
          <div class="mb-6" *ngIf="getTotalCartQuantity() > 0">
            <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-6 text-center border border-blue-200">
              <h4 class="text-2xl font-bold text-blue-900 mb-2">
                {{ 'ORDER.TOTAL_QUANTITY_IN_CART' | translate }}: {{ getTotalCartQuantity() }}
              </h4>
              <p class="text-blue-700">{{ 'ORDER.ADJUST_QUANTITIES_ABOVE' | translate }}</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Loading State -->
<div class="min-h-screen bg-gray-50 flex items-center justify-center" *ngIf="isLoading">
  <div class="bg-white rounded-2xl shadow-lg p-8 text-center">
    <div class="w-12 h-12 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
    <h5 class="text-lg font-semibold text-gray-900">جاري تحميل المنتج...</h5>
  </div>
</div>

<div *ngIf="authService.isAdmin && hasGeneralStock() && productVariants.length > 0" class="mb-4 flex justify-end">
  <button type="button"
    class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-semibold shadow"
    (click)="openSplitQuantityDialog()">
    <i class="bi bi-arrow-down-up mr-2"></i>
    قسّم الكمية العامة على المتغيرات
  </button>
</div>
