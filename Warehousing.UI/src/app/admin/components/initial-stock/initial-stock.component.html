<div class="container-fluid">
  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h4 class="mb-1">
        <i class="bi bi-box-seam me-2"></i>
        {{ 'INITIAL_STOCK.TITLE' | translate }}
      </h4>
      <p class="text-muted mb-0">{{ 'INITIAL_STOCK.DESCRIPTION' | translate }}</p>
    </div>
    <div>
      <button class="btn btn-outline-secondary me-2" (click)="clearForm()" [disabled]="isSubmitting">
        <i class="bi bi-arrow-clockwise me-1"></i>
        مسح الكل
      </button>
      <button class="btn btn-outline-primary" (click)="addStockItem()" [disabled]="isSubmitting">
        <i class="bi bi-plus-circle me-1"></i>
        {{ 'INITIAL_STOCK.ADD_PRODUCT' | translate }}
      </button>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="isLoading" class="text-center py-5">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">جاري التحميل...</span>
    </div>
    <p class="mt-3 text-muted">جاري تحميل البيانات...</p>
  </div>

  <!-- Form -->
  <div *ngIf="!isLoading" class="row">
    <div class="col-12">
      <form [formGroup]="initialStockForm" (ngSubmit)="onSubmit()">
        <!-- Notes Section -->
        <div class="card mb-4">
          <div class="card-header">
            <h6 class="mb-0">
              <i class="bi bi-chat-text me-2"></i>
              ملاحظات
            </h6>
          </div>
          <div class="card-body">
            <textarea 
              class="form-control" 
              formControlName="notes" 
              rows="3" 
              placeholder="أضف ملاحظات حول الرصيد الابتدائي (اختياري)">
            </textarea>
          </div>
        </div>

        <!-- Stock Items Section -->
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h6 class="mb-0">
              <i class="bi bi-list-ul me-2"></i>
              عناصر الرصيد الابتدائي
            </h6>
            <span class="badge bg-primary">{{ getTotalItems() }} عنصر</span>
          </div>
          <div class="card-body">
            <!-- Empty State -->
            <div *ngIf="itemsFormArray.length === 0" class="text-center py-5 text-muted">
              <i class="bi bi-inbox fs-1 mb-3"></i>
              <p>لا توجد عناصر مضافة</p>
              <p class="small">اضغط على "إضافة منتج" لبدء إدخال الرصيد الابتدائي</p>
            </div>

            <!-- Stock Items List -->
            <div *ngIf="itemsFormArray.length > 0">
              <div class="table-responsive">
                <table class="table table-hover">
                  <thead class="table-light">
                    <tr>
                      <th width="5%">#</th>
                      <th width="25%">المنتج</th>
                      <th width="20%">المستودع</th>
                      <th width="15%">الكمية</th>
                      <th width="10%">الإجراءات</th>
                    </tr>
                  </thead>
                  <tbody formArrayName="items">
                    <tr *ngFor="let item of itemsFormArray.controls; let i = index" [formGroupName]="i">
                      <td class="text-center">{{ i + 1 }}</td>
                      <td>
                        <select 
                          class="form-select" 
                          formControlName="productId"
                          [class.is-invalid]="item.get('productId')?.invalid && item.get('productId')?.touched">
                          <option value="">اختر المنتج</option>
                          <option *ngFor="let product of products" [value]="product.id">
                            {{ product.nameAr }} ({{ product.code }})
                          </option>
                        </select>
                        <div *ngIf="item.get('productId')?.invalid && item.get('productId')?.touched" class="invalid-feedback">
                          يرجى اختيار المنتج
                        </div>
                      </td>
                      <td>
                        <select 
                          class="form-select" 
                          formControlName="storeId"
                          [class.is-invalid]="item.get('storeId')?.invalid && item.get('storeId')?.touched">
                          <option value="">اختر المستودع</option>
                          <option *ngFor="let store of stores" [value]="store.id">
                            {{ store.name }}
                          </option>
                        </select>
                        <div *ngIf="item.get('storeId')?.invalid && item.get('storeId')?.touched" class="invalid-feedback">
                          يرجى اختيار المستودع
                        </div>
                      </td>
                      <td>
                        <input 
                          type="number" 
                          class="form-control" 
                          formControlName="quantity"
                          min="0"
                          step="0.01"
                          [class.is-invalid]="item.get('quantity')?.invalid && item.get('quantity')?.touched">
                        <div *ngIf="item.get('quantity')?.invalid && item.get('quantity')?.touched" class="invalid-feedback">
                          <div *ngIf="item.get('quantity')?.errors?.['required']">الكمية مطلوبة</div>
                          <div *ngIf="item.get('quantity')?.errors?.['min']">الكمية يجب أن تكون أكبر من أو تساوي 0</div>
                        </div>
                      </td>
                      <td>
                        <button 
                          type="button" 
                          class="btn btn-outline-danger btn-sm"
                          (click)="removeStockItem(i)"
                          [disabled]="isSubmitting">
                          <i class="bi bi-trash"></i>
                        </button>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>

              <!-- Summary -->
              <div class="row mt-4">
                <div class="col-md-6">
                  <div class="card bg-light">
                    <div class="card-body">
                      <h6 class="card-title">
                        <i class="bi bi-info-circle me-2"></i>
                        ملخص الرصيد الابتدائي
                      </h6>
                      <div class="row">
                        <div class="col-6">
                          <p class="mb-1"><strong>عدد العناصر:</strong></p>
                          <p class="mb-0 text-primary fs-5">{{ getTotalItems() }}</p>
                        </div>
                        <div class="col-6">
                          <p class="mb-1"><strong>إجمالي الكمية:</strong></p>
                          <p class="mb-0 text-success fs-5">{{ getTotalQuantity() | number:'1.2-2' }}</p>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Submit Button -->
        <div class="d-flex justify-content-end mt-4" *ngIf="itemsFormArray.length > 0">
          <button 
            type="submit" 
            class="btn btn-primary btn-lg"
            [disabled]="initialStockForm.invalid || isSubmitting">
            <span *ngIf="isSubmitting" class="spinner-border spinner-border-sm me-2"></span>
            <i *ngIf="!isSubmitting" class="bi bi-check-circle me-2"></i>
            {{ isSubmitting ? 'جاري الحفظ...' : 'حفظ الرصيد الابتدائي' }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
