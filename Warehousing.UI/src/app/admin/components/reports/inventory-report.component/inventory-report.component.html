<div class="container-fluid">
  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <!-- <h4>{{ 'REPORTS.INVENTORYREPORT' | translate }}</h4> -->
    <h4>تقرير الجرد</h4>
    <div class="p-2">
      <select class="form-select" [(ngModel)]="storeId" (change)="loadProducts()">
        <option [ngValue]="0">جميع الفروع</option>
        <option *ngFor="let store of stores" [ngValue]="store.id">
          {{ lang.currentLang === 'ar' ? store.nameAr : store.nameEn }}
        </option>
      </select>
    </div>
    <div class="mt-3 d-flex justify-content-center gap-2">
      <button class="btn btn-outline-primary btn-sm" (click)="printCurrentPage()">
        <i class="bi bi-printer me-1"></i> الصفحة الخالية
        <!-- {{ 'SHARED.BUTTONS.PRINT.CURRENTPAGE' | translate }} -->
      </button>
      <button class="btn btn-primary btn-sm" (click)="printAllPages()">
        <i class="bi bi-printer-fill me-1"></i> الكل
        <!-- {{ 'SHARED.BUTTONS.PRINT.ALLPAGES' | translate }} -->
      </button>
    </div>
  </div>

  <!-- Table -->
  <div class="table-responsive shadow-sm rounded">
    <table class="table table-striped table-hover align-middle mb-0">
      <thead class="table-light dark-mode-bg">
        <tr>
          <th>#</th>
          <!-- <th>{{ 'PRODUCTS.CODE' | translate }}</th>
          <th>{{ 'PRODUCTS.PRODUCTNAME' | translate }}</th>
          <th>{{ 'PRODUCTS.CATEGORY' | translate }}</th>
          <th>{{ 'PRODUCTS.UNIT' | translate }}</th>
          <th class="text-end">{{ 'PRODUCTS.COSTPRICE' | translate }}</th>
          <th class="text-end">{{ 'PRODUCTS.SELLINGPRICE' | translate }}</th>
          <th class="text-center">{{ 'PRODUCTS.QUANTITYINSTOCK' | translate }}</th>
          <th class="text-center">{{ 'PRODUCTS.REORDERLEVEL' | translate }}</th>
          <th class="text-center">{{ 'PRODUCTS.ISACTIVE' | translate }}</th> -->

          <th>الكود</th>
          <th>المنتج</th>
          <th>الصنف</th>
          <th>الوجدة</th>
          <th class="text-end">سعر الشراء</th>
          <th class="text-end">سعر البيع</th>
          <th class="text-center">الكمية</th>
          <th class="text-center">مستوى اعادة الطلب</th>
          <th class="text-center">الحالة</th>
        </tr>
      </thead>
      <tbody *ngIf="products$ | async as data">
        <tr *ngFor="let item of data.products; let i = index">
          <td>{{ (pageIndex - 1) * pageSize + i + 1 }}</td>
          <td>
            <a [routerLink]="['/admin/transaction', item.id]" class="text-decoration-underline text-primary"
              style="cursor: pointer;">
              {{ item.code }}
            </a>
          </td>

          <td>{{ lang.currentLang === 'ar' ? item.nameAr : item.nameEn }}</td>
          <td>{{ lang.currentLang === 'ar' ? item.subCategory?.nameAr : item.subCategory?.nameEn }}</td>
          <td>{{ lang.currentLang === 'ar' ? item.unit?.nameAr : item.unit?.nameEn }}</td>
          <td class="text-end">{{ item.costPrice | currency }}</td>
          <td class="text-end">{{ item.sellingPrice | currency }}</td>
          <!-- [class.text-danger]="item.productStores.quantityInStock < item.reorderLevel" -->
          <td class="text-center">
            <div *ngIf="item" class="d-flex justify-content-between mt-1">
              <span class="text-muted">{{ 'PRODUCTS.QUANTITYINSTOCK' | translate }}</span>
              <div class="d-flex justify-content-between mt-1">
                <span class="text-muted">{{ 'PRODUCTS.QUANTITYINSTOCK' | translate }}</span>
                <strong [class.text-danger]="item.quantityInStock <= item.reorderLevel!">
                  {{ item.quantityInStock }}
                  <small class="text-muted ms-1">
                    {{ lang.currentLang === 'ar' ? item?.unit?.nameAr : item?.unit?.nameEn }}
                  </small>
                </strong>
              </div>
            </div>
          </td>
          <td class="text-center">{{ item.reorderLevel }}</td>
          <td class="text-center">
            <span class="badge" [class.bg-success]="item.isActive" [class.bg-secondary]="!item.isActive">
              {{ item.isActive ? 'Active' : 'Inactive' }}
            </span>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  <nav aria-label="Page navigation" class="mt-4 d-flex justify-content-center">
    <ul class="pagination">
      <li class="page-item" [class.disabled]="pageIndex === 1">
        <button class="page-link btn" (click)="changePage(pageIndex - 1)">«</button>
      </li>

      <!-- First page -->
      <li class="page-item" [class.active]="pageIndex === 1">
        <button class="page-link btn" (click)="changePage(1)">1</button>
      </li>

      <!-- Left Ellipsis -->
      <li class="page-item disabled" *ngIf="pageIndex > 4">
        <span class="page-link">...</span>
      </li>

      <!-- Dynamic middle pages -->
      <li class="page-item" *ngFor="let page of getPageRange()" [class.active]="page === pageIndex">
        <button class="page-link btn" (click)="changePage(page)">{{ page }}</button>
      </li>

      <!-- Right Ellipsis -->
      <li class="page-item disabled" *ngIf="pageIndex < totalPages - 3">
        <span class="page-link">...</span>
      </li>

      <!-- Last page -->
      <li class="page-item" [class.active]="pageIndex === totalPages" *ngIf="totalPages > 1">
        <button class="page-link btn" (click)="changePage(totalPages)">{{ totalPages }}</button>
      </li>

      <li class="page-item" [class.disabled]="pageIndex === totalPages || totalPages === 0">
        <button class="page-link btn" (click)="changePage(pageIndex + 1)">»</button>
      </li>
    </ul>
  </nav>

  <!-- Hidden Print Template -->
  <div #printSection style="display: none;" *ngIf="products$ | async as data">
    <div dir="rtl" class="p-4">
      <!-- Company Header -->
      <ng-container *ngIf="storeId">
        <app-company-header></app-company-header>
      </ng-container>

      <!-- Title -->
      <!-- <h4 class="text-center my-3">
        {{ 'REPORTS.INVENTORYREPORT' | translate }} — {{ today | date }}
      </h4> -->
      <h4 class="text-center my-3">
        تقرير الجرد — {{ today | date }}
      </h4>

      <!-- Inventory Table -->
      <table class="table table-bordered small">
        <thead>
          <tr>
            <th>#</th>
            <!-- <th>{{ 'PRODUCTS.CODE' | translate }}</th>
            <th>{{ 'PRODUCTS.PRODUCTNAME' | translate }}</th>
            <th>{{ 'PRODUCTS.CATEGORY' | translate }}</th>
            <th>{{ 'PRODUCTS.UNIT' | translate }}</th>
            <th>{{ 'PRODUCTS.COSTPRICE' | translate }}</th>
            <th>{{ 'PRODUCTS.SELLINGPRICE' | translate }}</th>
            <th>{{ 'PRODUCTS.QUANTITYINSTOCK' | translate }}</th>
            <th>{{ 'PRODUCTS.REORDERLEVEL' | translate }}</th>
            <th>{{ 'PRODUCTS.ISACTIVE' | translate }}</th> -->

            <th>الكود</th>
            <th>المنتج</th>
            <th>الصنف</th>
            <th>الوجدة</th>
            <th>سعر الشراء</th>
            <th>سعر البيع</th>
            <th class="text-center">الكمية</th>
            <th class="text-center">مستوى اعادة الطلب</th>
            <th class="text-center">الحالة</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let item of data.products; let i = index">
            <td class="text-center">{{ (pageIndex - 1) * pageSize + i + 1 }}</td>
            <td>{{ item.code }}</td>
            <td>{{ lang.currentLang === 'ar' ? item.nameAr : item.nameEn }}</td>
            <td>{{ lang.currentLang === 'ar' ? item.subCategory?.nameAr : item.subCategory?.nameEn }}</td>
            <td>{{ lang.currentLang === 'ar' ? item.unit?.nameAr : item.unit?.nameEn }}</td>
            <td class="text-end">{{ item.costPrice| currency }}</td>
            <td class="text-end">{{ item.sellingPrice | currency }}</td>
            <!-- [class.text-danger]="item.productStores.quantityInStock < item.reorderLevel" -->
            <div *ngIf="item" class="d-flex justify-content-between mt-1">
              <span class="text-muted">{{ 'PRODUCTS.QUANTITYINSTOCK' | translate }}</span>
              <div class="d-flex justify-content-between mt-1">
                <span class="text-muted">{{ 'PRODUCTS.QUANTITYINSTOCK' | translate }}</span>
                <strong [class.text-danger]="item.quantityInStock <= item.reorderLevel!">
                  {{ item.quantityInStock }}
                  <small class="text-muted ms-1">
                    {{ lang.currentLang === 'ar' ? item?.unit?.nameAr : item?.unit?.nameEn }}
                  </small>
                </strong>
              </div>
            </div>
            <td class="text-center">{{ item.reorderLevel }}</td>
            <td class="text-center">
              <span class="badge" [class.bg-success]="item.isActive" [class.bg-secondary]="!item.isActive">
                {{ item.isActive ? 'Active' : 'Inactive' }}
              </span>
            </td>
          </tr>
        </tbody>
      </table>

      <!-- Summary Footer -->
      <div class="mt-5 text-center small">
        <p class="mb-1">Printed on: {{ today | date }}</p>
        <p class="mb-0">Powered by LsVision Accounting System</p>
      </div>

      <!-- Company Footer -->
      <ng-container *ngIf="storeId">
        <app-company-footer></app-company-footer>
      </ng-container>
    </div>
  </div>
</div>

<!-- Hidden Print Template -->
<div #printAllSection style="display: none;">
  <div [dir]="lang.currentLang === 'ar' ? 'rtl' : 'ltr'" class="p-4">
    <!-- Company Header -->
    <ng-container *ngIf="storeId">
      <app-company-header></app-company-header>
    </ng-container>

    <!-- Report Title -->
    <h4 class="text-center my-3">
      {{ 'REPORTS.INVENTORYREPORT' | translate }} — Printed on: {{ today | date }}
    </h4>

    <!-- Table -->
    <table class="table table-bordered small">
      <thead>
        <tr>
          <th>#</th>
          <!-- <th>{{ 'PRODUCTS.CODE' | translate }}</th>
          <th>{{ 'PRODUCTS.PRODUCTNAME' | translate }}</th>
          <th>{{ 'PRODUCTS.CATEGORY' | translate }}</th>
          <th>{{ 'PRODUCTS.UNIT' | translate }}</th>
          <th class="text-end">{{ 'PRODUCTS.COSTPRICE' | translate }}</th>
          <th class="text-end">{{ 'PRODUCTS.SELLINGPRICE' | translate }}</th>
          <th class="text-center">{{ 'PRODUCTS.QUANTITYINSTOCK' | translate }}</th>
          <th class="text-center">{{ 'PRODUCTS.REORDERLEVEL' | translate }}</th>
          <th class="text-center">{{ 'PRODUCTS.ISACTIVE' | translate }}</th> -->

          <th>الكود</th>
          <th>المنتج</th>
          <th>الصنف</th>
          <th>الوجدة</th>
          <th class="text-center">سعر الشراء</th>
          <th class="text-center">سعر البيع</th>
          <th class="text-center">الكمية</th>
          <th class="text-center">مستوى اعادة الطلب</th>
          <th class="text-center">الحالة</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let item of currentPrintData; let i = index">
          <td class="text-center">{{ i + 1 }}</td>
          <td>{{ item.code }}</td>
          <td>{{ lang.currentLang === 'ar' ? item.nameAr : item.nameEn }}</td>
          <td>{{ lang.currentLang === 'ar' ? item.category?.nameAr : item.category?.nameEn }}</td>
          <td>{{ lang.currentLang === 'ar' ? item.unit?.nameAr : item.unit?.nameEn }}</td>
          <td class="text-end">{{ item.costPrice | currency }}</td>
          <td class="text-end">{{ item.sellingPrice | currency }}</td>
          <td class="text-center" [class.text-danger]="item.quantityInStock < item.reorderLevel">
            {{ item.quantityInStock }}
          </td>
          <td class="text-center">{{ item.reorderLevel }}</td>
          <td class="text-center">
            <span class="badge" [class.bg-success]="item.isActive" [class.bg-secondary]="!item.isActive">
              {{ item.isActive ? 'Active' : 'Inactive' }}
            </span>
          </td>
        </tr>
        <!-- Summary Row -->
        <tr>
          <td colspan="7" class="text-end"><strong>Total Items:</strong></td>
          <td class="text-center"><strong>{{ currentPrintData.length }}</strong></td>
          <td colspan="2"></td>
        </tr>
      </tbody>
    </table>

    <!-- Footer -->
    <ng-container *ngIf="storeId">
      <app-company-footer></app-company-footer>
    </ng-container>
  </div>
</div>

<!-- Hidden Print Template -->
<div #printAllSection style="display: none;">
  <div [dir]="lang.currentLang === 'ar' ? 'rtl' : 'ltr'" class="p-4">
    <!-- Company Header -->
    <ng-container *ngIf="storeId">
      <app-company-header></app-company-header>
    </ng-container>

    <!-- Report Title -->
    <h4 class="text-center my-3">
      {{ 'REPORTS.INVENTORYREPORT' | translate }} — Printed on: {{ today | date }}
    </h4>

    <!-- Table -->
    <table class="table table-bordered small">
      <thead>
        <tr>
          <th>#</th>
          <!-- <th>{{ 'PRODUCTS.CODE' | translate }}</th>
          <th>{{ 'PRODUCTS.PRODUCTNAME' | translate }}</th>
          <th>{{ 'PRODUCTS.CATEGORY' | translate }}</th>
          <th>{{ 'PRODUCTS.UNIT' | translate }}</th>
          <th class="text-end">{{ 'PRODUCTS.COSTPRICE' | translate }}</th>
          <th class="text-end">{{ 'PRODUCTS.SELLINGPRICE' | translate }}</th>
          <th class="text-center">{{ 'PRODUCTS.QUANTITYINSTOCK' | translate }}</th>
          <th class="text-center">{{ 'PRODUCTS.REORDERLEVEL' | translate }}</th> -->

          <th>الكود</th>
          <th>المنتج</th>
          <th>الصنف</th>
          <th>الوجدة</th>
          <th class="text-center">سعر الشراء</th>
          <th class="text-center">سعر البيع</th>
          <th class="text-center">الكمية</th>
          <th class="text-center">مستوى اعادة الطلب</th>
          <th class="text-center">الحالة</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let item of currentPrintData; let i = index">
          <td class="text-center">{{ i + 1 }}</td>
          <td>{{ item.code }}</td>
          <td>{{ lang.currentLang === 'ar' ? item.nameAr : item.nameEn }}</td>
          <td>{{ lang.currentLang === 'ar' ? item.category?.nameAr : item.category?.nameEn }}</td>
          <td>{{ lang.currentLang === 'ar' ? item.unit?.nameAr : item.unit?.nameEn }}</td>
          <td class="text-end">{{ item.costPrice | currency }}</td>
          <td class="text-end">{{ item.sellingPrice | currency }}</td>
          <td class="text-center" [class.text-danger]="item.quantityInStock < item.reorderLevel">
            {{ item.quantityInStock }}
          </td>
          <td class="text-center">{{ item.reorderLevel }}</td>
        </tr>
      </tbody>
    </table>

    <!-- Footer -->
    <ng-container *ngIf="storeId">
      <app-company-footer></app-company-footer>
    </ng-container>
  </div>
</div>