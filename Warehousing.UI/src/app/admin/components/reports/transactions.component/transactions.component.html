<div class="container-fluid">
    <!-- Back + Header -->
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
        <!-- Back Button -->
        <button class="btn btn-link p-0 text-decoration-none d-flex align-items-center" type="button"
            (click)="goBack()">
            <i class="bi bi-arrow-left-circle-fill me-2 fs-5"></i>
        </button>

        <!-- Title -->
        <h4 class="fw-bold dark-mode-text mb-0 flex-grow-1 text-center text-md-start">
            {{ 'INVENTORYTRANSACTIONS.TITLE' | translate }}
        </h4>

        <div class="d-flex justify-content-between align-items-center mb-4">
            <div class="p-2">
                <select class="form-select" [(ngModel)]="storeId" (change)="loadProductDetails()">
                    <option [ngValue]="0">جميع الفروع</option>
                    <option *ngFor="let store of stores" [ngValue]="store.id">
                        {{ lang.currentLang === 'ar' ? store.nameAr : store.nameEn }}
                    </option>
                </select>
            </div>
        </div>

        <!-- Print Button -->
        <div class="d-flex gap-2 w-sm-100">
            <button class="btn btn-outline-dark d-flex align-items-center" type="button" (click)="printTransactions()">
                <i class="bi bi-printer me-1"></i>
            </button>
        </div>
    </div>

    <!-- Responsive Table -->
    <div class="table-responsive shadow-sm rounded">
        <table class="table table-striped table-hover align-middle mb-0">
            <thead class="table-light">
                <tr>
                    <th>#</th>
                    <th>{{ 'INVENTORYTRANSACTIONS.TRANSACTIONDATE' | translate }}</th>
                    <th>{{ 'INVENTORYTRANSACTIONS.TRANSACTIONTYPEID' | translate }}</th>
                    <th>{{ 'INVENTORYTRANSACTIONS.PRODUCTID' | translate }}</th>
                    <th>{{ 'INVENTORYTRANSACTIONS.QUANTITYCHANGED' | translate }}</th>
                    <th>{{ 'INVENTORYTRANSACTIONS.BALANCE' | translate }}</th>
                    <th>{{ 'INVENTORYTRANSACTIONS.NOTES' | translate }}</th>
                </tr>
            </thead>
            <tbody *ngIf="transactions$ | async as data">
                <tr *ngFor="let t of data.transactions; let i = index">
                    <td>{{ (pageIndex - 1) * pageSize + i + 1 }}</td>
                    <td>{{ t.transactionDate | date }}</td>
                    <td>
                        <span class="badge" [class.bg-success]="t.transactionType.code === 'PURCHASE'"
                            [class.bg-danger]="t.transactionType.code === 'SALE'">
                            {{ lang.currentLang === 'ar' ? t.transactionType.nameAr : t.transactionType.nameEn }}
                        </span>
                    </td>
                    <td>{{ lang.currentLang === 'ar' ? t.product.nameAr : t.product.nameEn }}</td>
                    <td class="text-center" [class.text-danger]="t.quantityChanged < 0">
                        {{ t.quantityChanged > 0 ? '+' : '' }}{{ t.quantityChanged }}
                    </td>
                    <td class="text-center">
                        <div *ngIf="t.product" class="d-flex justify-content-between mt-1">
                            <span class="text-muted">{{ 'PRODUCTS.QUANTITYINSTOCK' | translate }}</span>
                            <div class="d-flex justify-content-between mt-1">
                                <span class="text-muted">{{ 'PRODUCTS.QUANTITYINSTOCK' | translate }}</span>
                                <strong [class.text-danger]="t.product.quantityInStock <= t.product.reorderLevel!">
                                    {{ t.product.quantityInStock }}
                                    <small class="text-muted ms-1">
                                        {{ lang.currentLang === 'ar' ? t.product?.unit?.nameAr : t.product?.unit?.nameEn }}
                                    </small>
                                </strong>
                            </div>
                        </div>
                    </td>
                    <td>{{ t.notes }}</td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Empty State -->
    <div *ngIf="(transactions$ | async)?.transactions?.length === 0" class="alert alert-info text-center mt-4">
        {{ 'SHARED.NO_DATA' | translate }}
    </div>

    <!-- Pagination -->
    <nav aria-label="Page navigation" class="mt-4 d-flex justify-content-center">
        <ul class="pagination">
            <!-- Previous -->
            <li class="page-item" [class.disabled]="pageIndex === 1">
                <button class="page-link btn" (click)="changePage(pageIndex - 1)">«</button>
            </li>

            <!-- First Page -->
            <li class="page-item" [class.active]="pageIndex === 1">
                <button class="page-link btn" (click)="changePage(1)">1</button>
            </li>

            <!-- Left Ellipsis -->
            <li class="page-item disabled" *ngIf="pageIndex > 4">
                <span class="page-link">...</span>
            </li>

            <!-- Middle Pages -->
            <li class="page-item" *ngFor="let page of getPageRange()" [class.active]="page === pageIndex">
                <button class="page-link btn" (click)="changePage(page)">
                    {{ page }}
                </button>
            </li>

            <!-- Right Ellipsis -->
            <li class="page-item disabled" *ngIf="pageIndex < totalPages - 3">
                <span class="page-link">...</span>
            </li>

            <!-- Last Page -->
            <li class="page-item" [class.active]="pageIndex === totalPages" *ngIf="totalPages > 1">
                <button class="page-link btn" (click)="changePage(totalPages)">
                    {{ totalPages }}
                </button>
            </li>

            <!-- Next -->
            <li class="page-item" [class.disabled]="pageIndex >= totalPages || totalPages === 0">
                <button class="page-link btn" (click)="changePage(pageIndex + 1)">»</button>
            </li>
        </ul>
    </nav>
</div>

<!-- Hidden Print Template -->
<div #printSection style="display: none;" *ngIf="transactions$ | async as data">
    <div [dir]="lang.currentLang === 'ar' ? 'rtl' : 'ltr'" class="p-4">
        <!-- Company Header -->
        <ng-container>
            <app-company-header></app-company-header>
        </ng-container>

        <!-- Report Title -->
        <h4 class="text-center my-3">
            {{ 'INVENTORYTRANSACTIONS.TITLE' | translate }} – Product ID: {{ productId }}
        </h4>

        <!-- Transaction Table -->
        <table class="table table-bordered small">
            <thead>
                <tr>
                    <th>#</th>
                    <th>{{ 'INVENTORYTRANSACTIONS.TRANSACTIONDATE' | translate }}</th>
                    <th>{{ 'INVENTORYTRANSACTIONS.TRANSACTIONTYPEID' | translate }}</th>
                    <th>{{ 'INVENTORYTRANSACTIONS.PRODUCTID' | translate }}</th>
                    <th>{{ 'INVENTORYTRANSACTIONS.QUANTITYCHANGED' | translate }}</th>
                    <th>{{ 'INVENTORYTRANSACTIONS.BALANCE' | translate }}</th>
                    <th>{{ 'INVENTORYTRANSACTIONS.NOTES' | translate }}</th>
                </tr>
            </thead>
            <tbody>
                <tr *ngFor="let t of data.transactions; let i = index">
                    <td class="text-center">{{ i + 1 }}</td>
                    <td>{{ t.transactionDate | date }}</td>
                    <td class="text-center">
                        <span class="badge" [class.bg-success]="t.transactionType.code === 'PURCHASE'"
                            [class.bg-danger]="t.transactionType.code === 'SALE'">
                            {{ lang.currentLang === 'ar' ? t.transactionType.nameAr : t.transactionType.nameEn }}
                        </span>
                    </td>
                    <td>{{ lang.currentLang === 'ar' ? t.product.nameAr : t.product.nameEn }}</td>
                    <td class="text-end" [class.text-danger]="t.quantityChanged < 0">
                        {{ t.quantityChanged > 0 ? '+' : '' }}{{ t.quantityChanged }}
                    </td>
                    <td class="text-end">
                        <div *ngIf="t.product" class="d-flex justify-content-between mt-1">
                            <span class="text-muted">{{ 'PRODUCTS.QUANTITYINSTOCK' | translate }}</span>
                            <div class="d-flex justify-content-between mt-1">
                                <span class="text-muted">{{ 'PRODUCTS.QUANTITYINSTOCK' | translate }}</span>
                                <strong [class.text-danger]="t.product.quantityInStock <= t.product.reorderLevel!">
                                    {{ t.product.quantityInStock }}
                                    <small class="text-muted ms-1">
                                        {{ lang.currentLang === 'ar' ? t.product?.unit?.nameAr : t.product?.unit?.nameEn }}
                                    </small>
                                </strong>
                            </div>
                        </div>
                    </td>
                    <td>{{ t.notes }}</td>
                </tr>
            </tbody>
        </table>

        <!-- Summary Footer -->
        <div class="mt-5 text-center small">
            <p class="mb-1">Opening Balance: {{ data.transactions[0].product.openingBalance }}</p>
            <p class="mb-1">Total Movement:
                {{ data.transactions | getQuantityChangedSum }}
            </p>
            <p class="mb-0">
                <strong>Final Balance:</strong>
                {{ finalBalance }}
            </p>
        </div>

        <!-- Company Footer -->
        <ng-container>
            <app-company-footer></app-company-footer>
        </ng-container>
    </div>
</div>